<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Insight Gaps | Forensic Data Journalism Bureau</title>
  <meta name="description" content="Insight Gaps is an independent forensic data journalism and operational intelligence bureau. Live world data, investigative reports, and applied analysis.">
  <link rel="icon" href="/favicon.png" type="image/png">
  <link rel="stylesheet" href="/style.css">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4PYE0MEK12"></script>
  <script>
    window.dataLayer=window.dataLayer||[];
    function gtag(){dataLayer.push(arguments);}
    gtag('js',new Date()); gtag('config','G-4PYE0MEK12');
  </script>
</head>
<body>

<div class="ticker-bar" role="marquee" aria-label="Live data ticker">
  <div class="ticker-label">LIVE</div>
  <div class="ticker-track-wrap">
    <div class="ticker-track" id="tickerTrack">
      <span class="ticker-item"><span class="ti-tag">BDT/USD</span> <span id="tick-bdt">—</span></span>
      <span class="ticker-item"><span class="ti-tag">EUR/USD</span> <span id="tick-eur">—</span></span>
      <span class="ticker-item"><span class="ti-tag">GBP/USD</span> <span id="tick-gbp">—</span></span>
      <span class="ticker-item"><span class="ti-tag">JPY/USD</span> <span id="tick-jpy">—</span></span>
      <span class="ticker-item"><span class="ti-tag">CNY/USD</span> <span id="tick-cny">—</span></span>
      <span class="ticker-item"><span class="ti-tag">DHAKA AQI</span> <span id="tick-dhaka-aqi">—</span></span>
      <span class="ticker-item"><span class="ti-tag">DELHI AQI</span>  <span id="tick-delhi-aqi">—</span></span>
      <span class="ticker-item"><span class="ti-tag">BEIJING AQI</span><span id="tick-bj-aqi">—</span></span>
      <span class="ticker-item"><span class="ti-tag">INSIGHT GAPS</span> Forensic Data Journalism Bureau — Independent · Public Interest</span>
      <span class="ticker-item"><span class="ti-tag">BDT/USD</span> <span class="tick-bdt2">—</span></span>
      <span class="ticker-item"><span class="ti-tag">EUR/USD</span> <span class="tick-eur2">—</span></span>
      <span class="ticker-item"><span class="ti-tag">GBP/USD</span> <span class="tick-gbp2">—</span></span>
      <span class="ticker-item"><span class="ti-tag">JPY/USD</span> <span class="tick-jpy2">—</span></span>
      <span class="ticker-item"><span class="ti-tag">DHAKA AQI</span> <span class="tick-dhaka2">—</span></span>
      <span class="ticker-item"><span class="ti-tag">INSIGHT GAPS</span> Forensic Data Journalism Bureau — Independent · Public Interest</span>
    </div>
  </div>
</div>

<div data-include="header" data-path="/includes/header.html"></div>

<main role="main">

  <div class="masthead">
    <div class="masthead-inner wrap">
      <p class="masthead-pub">Est. 2025 &nbsp;·&nbsp; Dhaka &nbsp;·&nbsp; Independent</p>
      <h1 class="masthead-title">Insight <em>Gaps</em></h1>
      <p class="masthead-sub">Forensic Data Journalism &amp; Operational Intelligence Bureau</p>
    </div>
  </div>

  <div class="live-strip" role="complementary" aria-label="Live market and environment data">
    <div class="live-strip-inner">
      <div class="live-item">
        <div class="live-item-label">BDT / USD <span class="live-dot"></span></div>
        <div class="live-item-value loading" id="strip-bdt">···</div>
      </div>
      <div class="live-item">
        <div class="live-item-label">EUR / USD</div>
        <div class="live-item-value loading" id="strip-eur">···</div>
      </div>
      <div class="live-item">
        <div class="live-item-label">GBP / USD</div>
        <div class="live-item-value loading" id="strip-gbp">···</div>
      </div>
      <div class="live-item">
        <div class="live-item-label">JPY / USD</div>
        <div class="live-item-value loading" id="strip-jpy">···</div>
      </div>
      <div class="live-item">
        <div class="live-item-label">CNY / USD</div>
        <div class="live-item-value loading" id="strip-cny">···</div>
      </div>
      <div class="live-item">
        <div class="live-item-label">Dhaka AQI <span class="live-dot"></span></div>
        <div class="live-item-value loading" id="strip-dhaka">···</div>
      </div>
      <div class="live-item">
        <div class="live-item-label">Delhi AQI</div>
        <div class="live-item-value loading" id="strip-delhi">···</div>
      </div>
      <div class="live-item">
        <div class="live-item-label">Beijing AQI</div>
        <div class="live-item-value loading" id="strip-beijing">···</div>
      </div>
      <div class="live-item">
        <div class="live-item-label">London AQI</div>
        <div class="live-item-value loading" id="strip-london">···</div>
      </div>
      <div class="live-item">
        <div class="live-item-label">Updated</div>
        <div class="live-item-value" id="strip-time" style="font-size:0.68rem; color:rgba(255,255,255,0.35);">—</div>
      </div>
    </div>
  </div>

  <div class="home-grid">

    <div class="hero-investigation">
      <span class="hero-section-label">Featured Investigation</span>

      <div class="hero-content-wrap">
        <span class="hero-tag">New Release · February 2026</span>
        <h2 class="hero-headline">Blood Routes:<br>The Dhaka Bus Fatalities Investigation</h2>
        <p class="hero-dek">
          An open-source forensic dataset on bus-related fatalities in Dhaka, the structural incentives of the 
          waybill system, and the accountability failures that perpetuate them.
        </p>
        <div class="hero-meta">
          <span>Published February 2026</span>
          <span class="sep">·</span>
          <span>155+ Sources</span>
          <span class="sep">·</span>
          <span>Evidence Tier: Confirmed</span>
        </div>

        <div style="margin-top: 36px; padding-top: 28px; border-top: 1px solid var(--border);">
          <p style="font-family: var(--sans); font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-4); margin-bottom: 16px;">Primary Findings</p>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <div style="display: flex; gap: 12px; align-items: flex-start;">
              <span style="font-family: var(--mono); font-size: 0.65rem; color: var(--red); flex-shrink:0; padding-top:2px;">01</span>
              <p style="font-family: var(--sans); font-size: 0.88rem; color: var(--text-2); margin:0; max-width:100%;">
                <strong>The Data Gap:</strong> Official figures undercount road fatalities by a factor of approximately 5.8× compared to WHO estimates.
              </p>
            </div>
            <div style="display: flex; gap: 12px; align-items: flex-start;">
              <span style="font-family: var(--mono); font-size: 0.65rem; color: var(--red); flex-shrink:0; padding-top:2px;">02</span>
              <p style="font-family: var(--sans); font-size: 0.88rem; color: var(--text-2); margin:0; max-width:100%;">
                <strong>Phoenix Rebranding:</strong> Documented patterns of banned operators (e.g., Suprobhat) rebranding as Victor Classic and Akash to bypass enforcement.
              </p>
            </div>
            <div style="display: flex; gap: 12px; align-items: flex-start;">
              <span style="font-family: var(--mono); font-size: 0.65rem; color: var(--red); flex-shrink:0; padding-top:2px;">03</span>
              <p style="font-family: var(--sans); font-size: 0.88rem; color: var(--text-2); margin:0; max-width:100%;">
                <strong>Economic Incentives:</strong> The "Joma" system creates rational incentives for bus racing, directly compounding pedestrian risk.
              </p>
            </div>
          </div>
        </div>

        <div style="margin-top: 32px;">
          <a href="/investigations/blood-routes_road accident.html" class="btn-report" style="display: inline-block; padding: 12px 24px; background: var(--red); color: #fff; text-decoration: none; font-family: var(--mono); font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; border-radius: 2px;">View Full Investigation →</a>
        </div>
      </div>
    </div>

    <aside>
      <div style="border-bottom: 2px solid var(--text-1); padding-bottom: 8px; margin-bottom: 0;">
        <span style="font-family: var(--sans); font-size: 0.72rem; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: var(--text-3);">Analysis — Published</span>
      </div>
      <div class="hero-sub-stories">
        <div class="sub-story">
          <div class="ss-content">
            <div class="ss-num">01 — CASH FLOW</div>
            <div class="ss-title"><a href="/analysis/property-preservation/financial-health.html">Financial Health: The Cash Chain</a></div>
            <div class="ss-cat">Property Preservation · Jan 2026</div>
          </div>
        </div>
        <div class="sub-story">
          <div class="ss-content">
            <div class="ss-num">02 — LEAKAGE</div>
            <div class="ss-title"><a href="/analysis/property-preservation/leakage-breakdown.html">Leakage Breakdown: Structural Autopsy</a></div>
            <div class="ss-cat">Property Preservation · Jan 2026</div>
          </div>
        </div>
        <div class="sub-story">
          <div class="ss-content">
            <div class="ss-num">03 — WORK ORDER</div>
            <div class="ss-title"><a href="/analysis/property-preservation/work-order-breakdown.html">Work Order Risk Breakdown</a></div>
            <div class="ss-cat">Property Preservation · Jan 2026</div>
          </div>
        </div>
        <div class="sub-story">
          <div class="ss-content">
            <div class="ss-num">UPCOMING</div>
            <div class="ss-title" style="opacity:0.4; cursor:default;">Revenue Cycle Management Analysis</div>
            <div class="ss-cat" style="opacity:0.4;">In Development</div>
          </div>
        </div>
        <div class="sub-story" style="border-bottom:none;">
          <div class="ss-content">
            <div class="ss-num">UPCOMING</div>
            <div class="ss-title" style="opacity:0.4; cursor:default;">Compliance Gaps — Sector Report</div>
            <div class="ss-cat" style="opacity:0.4;">In Development</div>
          </div>
        </div>
      </div>

      <div style="margin-top: 28px; background: var(--ink); padding: 24px; border-radius: 3px;">
        <p style="font-family: var(--sans); font-size: 0.7rem; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: rgba(255,255,255,0.35); margin-bottom: 10px; max-width:100%;">Commissioned Diagnostics</p>
        <p style="font-family: var(--sans); font-size: 0.88rem; color: rgba(255,255,255,0.55); line-height: 1.6; margin-bottom: 14px; max-width:100%;">Limited private engagements accepted. Same forensic standards as public work.</p>
        <a href="mailto:insightgaps@gmail.com" style="font-family: var(--sans); font-size: 0.78rem; font-weight: 700; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 2px; text-decoration:none; transition: border-color .15s;" onmouseover="this.style.borderColor='#fff'" onmouseout="this.style.borderColor='rgba(255,255,255,0.3)'">insightgaps@gmail.com →</a>
      </div>
    </aside>
  </div>

  <div class="world-data-section">
    <div class="wds-inner">

      <div class="wds-header">
        <h2 class="wds-title">Global Data Snapshot</h2>
        <div class="wds-timestamp">
          <span class="live-dot"></span>
          <span id="data-timestamp">Fetching live data…</span>
        </div>
      </div>

      <div style="margin-bottom: 12px;">
        <span style="font-family: var(--sans); font-size: 0.68rem; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: rgba(255,255,255,0.35);">Air Quality Index — Major Cities</span>
      </div>
      <div class="aqi-grid" id="aqiGrid">
        <div class="aqi-card aqi-loading-card" style="background: var(--panel-surface); border: 1px solid var(--panel-border); border-radius: 3px; padding: 20px;">
          <div style="font-family: var(--mono); font-size: 0.62rem; color: rgba(255,255,255,0.3); animation: blink 1.4s infinite;">Loading AQI data…</div>
        </div>
      </div>

      <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 40px;">
        <span style="font-family: var(--sans); font-size: 0.62rem; color: rgba(255,255,255,0.25); font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em;">Scale:</span>
        <span style="font-family: var(--mono); font-size: 0.62rem; color: #4ade80;">0–50 Good</span>
        <span style="font-family: var(--mono); font-size: 0.62rem; color: #facc15;">51–100 Moderate</span>
        <span style="font-family: var(--mono); font-size: 0.62rem; color: #fb923c;">101–150 Sensitive</span>
        <span style="font-family: var(--mono); font-size: 0.62rem; color: #f87171;">151–200 Unhealthy</span>
        <span style="font-family: var(--mono); font-size: 0.62rem; color: #c084fc;">201–300 Very Unhealthy</span>
        <span style="font-family: var(--mono); font-size: 0.62rem; color: #f97316;">300+ Hazardous</span>
      </div>

      <div style="margin-bottom: 12px;">
        <span style="font-family: var(--sans); font-size: 0.68rem; font-weight: 700; letter-spacing: 0.14em; text-transform: uppercase; color: rgba(255,255,255,0.35);">Currency Exchange Rates vs USD</span>
      </div>
      <div class="market-row" id="marketRow">
        <div class="market-card">
          <div class="mc-label">BDT / USD</div>
          <div class="mc-value loading" id="curr-bdt">···</div>
          <div class="mc-change neu" id="curr-bdt-note">Bangladeshi Taka</div>
        </div>
        <div class="market-card">
          <div class="mc-label">EUR / USD</div>
          <div class="mc-value loading" id="curr-eur">···</div>
          <div class="mc-change neu" id="curr-eur-note">Euro</div>
        </div>
        <div class="market-card">
          <div class="mc-label">GBP / USD</div>
          <div class="mc-value loading" id="curr-gbp">···</div>
          <div class="mc-change neu" id="curr-gbp-note">British Pound</div>
        </div>
        <div class="market-card">
          <div class="mc-label">JPY / USD</div>
          <div class="mc-value loading" id="curr-jpy">···</div>
          <div class="mc-change neu" id="curr-jpy-note">Japanese Yen</div>
        </div>
        <div class="market-card">
          <div class="mc-label">CNY / USD</div>
          <div class="mc-value loading" id="curr-cny">···</div>
          <div class="mc-change neu" id="curr-cny-note">Chinese Yuan</div>
        </div>
        <div class="market-card">
          <div class="mc-label">INR / USD</div>
          <div class="mc-value loading" id="curr-inr">···</div>
          <div class="mc-change neu" id="curr-inr-note">Indian Rupee</div>
        </div>
      </div>

      <p style="font-family: var(--mono); font-size: 0.6rem; color: rgba(255,255,255,0.18); margin-top: 20px; max-width:100%;">
        Data sources: WAQI API (air quality) · Fawaz Ahmed Open Currency API (exchange rates). Updated on page load.
      </p>
    </div>
  </div>

  <section class="news-section" aria-labelledby="news-heading">
    <div class="section-rule">
      <div class="section-rule-line"></div>
      <span class="section-rule-title">World News</span>
      <div class="section-rule-line"></div>
      <span class="section-rule-meta" id="news-updated">Live feed</span>
    </div>

    <div class="news-grid" id="newsGrid">
      <div class="news-loading">Fetching world news…</div>
    </div>

    <div class="news-strip" id="newsStrip" style="display:none;"></div>

    <p style="font-family: var(--mono); font-size: 0.6rem; color: var(--text-4); margin-top: 14px; margin-bottom: 0; max-width:100%;">
      Source: BBC World Service RSS · Reuters World. Content is sourced from public RSS feeds and does not reflect editorial positions of Insight Gaps.
    </p>
  </section>

  <section class="analysis-home" aria-labelledby="analysis-heading">
    <div class="section-rule">
      <div class="section-rule-line"></div>
      <span class="section-rule-title">Applied Analysis</span>
      <div class="section-rule-line"></div>
      <span class="section-rule-meta"><a href="/analysis/" style="color: var(--text-4); font-size: 0.68rem;">View all →</a></span>
    </div>

    <p style="font-family: var(--sans); font-size: 1rem; font-weight: 300; color: var(--text-3); max-width: 62ch; margin-bottom: 0;">
      Operational intelligence derived from forensic investigations. Published openly. Available as private commissioned diagnostics.
    </p>

    <div class="forensic-grid">

      <article class="forensic-card">
        <div class="card-preview-stage"
             onclick="openPopup('/analysis/property-preservation/images/financial-dashboard.png','Financial Health Dashboard','/analysis/property-preservation/financial-health.html')"
             role="button" aria-label="Preview Financial Health Dashboard">
          <img src="/analysis/property-preservation/images/financial-dashboard.png" alt="Financial Health Dashboard" class="card-preview-img">
        </div>
        <div class="card-content">
          <span class="card-tag financial">Cash Flow Risk</span>
          <div class="card-meta"><span>January 2026</span></div>
          <h3>Financial Health: The Cash Chain</h3>
          <p>Tracks how revenue moves through invoicing and collection to expose where retention breaks down.</p>
          <a href="/analysis/property-preservation/financial-health.html" class="btn-report">View Analysis →</a>
        </div>
      </article>

      <article class="forensic-card">
        <div class="card-preview-stage"
             onclick="openPopup('/analysis/property-preservation/images/leakage-map.png','Leakage Breakdown','/analysis/property-preservation/leakage-breakdown.html')"
             role="button" aria-label="Preview Leakage Breakdown">
          <img src="/analysis/property-preservation/images/leakage-map.png" alt="Leakage map" class="card-preview-img">
        </div>
        <div class="card-content">
          <span class="card-tag leakage">Profit Leakage</span>
          <div class="card-meta"><span>January 2026</span></div>
          <h3>Leakage Breakdown: Structural Autopsy</h3>
          <p>Recurring margin erosion caused by vendor overruns and rework loops — mapped and classified.</p>
          <a href="/analysis/property-preservation/leakage-breakdown.html" class="btn-report">View Analysis →</a>
        </div>
      </article>

      <article class="forensic-card">
        <div class="card-preview-stage"
             onclick="openPopup('/analysis/property-preservation/images/risk-matrix.png','Work Order Risk Matrix','/analysis/property-preservation/work-order-breakdown.html')"
             role="button" aria-label="Preview Work Order Risk Matrix">
          <img src="/analysis/property-preservation/images/risk-matrix.png" alt="Risk matrix" class="card-preview-img">
        </div>
        <div class="card-content">
          <span class="card-tag workorder">Work Order Risk</span>
          <div class="card-meta"><span>January 2026</span></div>
          <h3>Work Order Breakdown</h3>
          <p>Identifies which service types scale profitably and which quietly magnify operational risk.</p>
          <a href="/analysis/property-preservation/work-order-breakdown.html" class="btn-report">View Analysis →</a>
        </div>
      </article>
    </div>
  </section>

</main>

<div id="imagePopup" class="popup-overlay" onclick="closePopup()" role="dialog" aria-modal="true">
  <div class="popup-content" onclick="event.stopPropagation()">
    <button class="popup-close" onclick="closePopup()" aria-label="Close">&times;</button>
    <a id="popupLink" href="#"><img id="popupImg" src="" alt="Preview" class="popup-image"></a>
    <div id="popupCaption" class="popup-caption"></div>
  </div>
</div>

<div data-include="footer" data-path="/includes/footer.html"></div>

<script src="/js/components.js"></script>
<script src="/js/ui.js"></script>

<script>
(function() {
  'use strict';

  /* ─── Helpers ─── */
  function setText(id, val) {
    var el = document.getElementById(id);
    if (el) { el.textContent = val; el.classList.remove('loading'); }
  }
  function setClass(id, cls) {
    var el = document.getElementById(id);
    if (el) el.className = el.className.replace(/\b(pos|neg|neu|loading)\b/g,'').trim() + ' ' + cls;
  }
  function formatRate(n, decimals) {
    if (!n) return '—';
    return parseFloat(n).toFixed(decimals !== undefined ? decimals : 4);
  }

  /* ─── Timestamp ─── */
  function nowStr() {
    var d = new Date();
    return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', timeZoneName: 'short' });
  }

  /* ══════════════════════════════════════
     1. CURRENCY DATA
     Source: cdn.jsdelivr.net/npm/@fawazahmed0/currency-api
     100% free, CDN-backed, no auth required
  ══════════════════════════════════════ */
  function fetchCurrencies() {
    var url = 'https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.min.json';
    fetch(url)
      .then(function(r){ return r.json(); })
      .then(function(data) {
        var r = data.usd;
        if (!r) return;

        /* Strip prices per 1 USD */
        var bdt = r.bdt, eur = r.eur, gbp = r.gbp, jpy = r.jpy, cny = r.cny, inr = r.inr;

        // Live strip
        setText('tick-bdt',  '৳' + formatRate(bdt, 2));
        setText('tick-eur',  '€' + formatRate(eur, 4));
        setText('tick-gbp',  '£' + formatRate(gbp, 4));
        setText('tick-jpy',  '¥' + formatRate(jpy, 2));
        setText('tick-cny',  '¥' + formatRate(cny, 4));
        document.querySelectorAll('.tick-bdt2').forEach(function(el){ el.textContent = '৳'+formatRate(bdt,2); });
        document.querySelectorAll('.tick-eur2').forEach(function(el){ el.textContent = '€'+formatRate(eur,4); });
        document.querySelectorAll('.tick-gbp2').forEach(function(el){ el.textContent = '£'+formatRate(gbp,4); });
        document.querySelectorAll('.tick-jpy2').forEach(function(el){ el.textContent = '¥'+formatRate(jpy,2); });

        // Strip bar
        setText('strip-bdt', '৳' + formatRate(bdt,2));
        setText('strip-eur', '€' + formatRate(eur,4));
        setText('strip-gbp', '£' + formatRate(gbp,4));
        setText('strip-jpy', '¥' + formatRate(jpy,2));
        setText('strip-cny', '¥' + formatRate(cny,4));

        // World data cards
        setText('curr-bdt', '৳ ' + formatRate(bdt,2));
        setText('curr-eur', '€ ' + formatRate(eur,4));
        setText('curr-gbp', '£ ' + formatRate(gbp,4));
        setText('curr-jpy', '¥ ' + formatRate(jpy,2));
        setText('curr-cny', '¥ ' + formatRate(cny,4));
        setText('curr-inr', '₹ ' + formatRate(inr,2));

        setText('strip-time', nowStr());
        setText('data-timestamp', 'Updated ' + nowStr());
      })
      .catch(function(){ /* silent — shows '···' placeholder */ });
  }

  /* ══════════════════════════════════════
     2. AIR QUALITY INDEX (AQI)
     Source: api.waqi.info — demo token
  ══════════════════════════════════════ */
  var AQI_TOKEN = 'demo'; // Public demo token — rate limited but functional

  var cities = [
    { id: 'dhaka',   name: 'Dhaka',     slug: 'dhaka',   stripId: 'strip-dhaka',  tickId: 'tick-dhaka-aqi'  },
    { id: 'delhi',   name: 'Delhi',     slug: 'delhi',   stripId: 'strip-delhi',  tickId: 'tick-delhi-aqi'  },
    { id: 'beijing', name: 'Beijing',   slug: 'beijing', stripId: 'strip-beijing',tickId: 'tick-bj-aqi'     },
    { id: 'london',  name: 'London',    slug: 'london',  stripId: 'strip-london', tickId: null              },
    { id: 'newyork', name: 'New York',  slug: 'new-york',stripId: null,           tickId: null              },
    { id: 'tokyo',   name: 'Tokyo',     slug: 'tokyo',   stripId: null,           tickId: null              },
    { id: 'mumbai',  name: 'Mumbai',    slug: 'mumbai',  stripId: null,           tickId: null              },
    { id: 'shanghai',name: 'Shanghai',  slug: 'shanghai',stripId: null,           tickId: null              },
  ];

  function aqiClass(v) {
    if (v === null) return 'aqi-moderate';
    if (v <= 50)   return 'aqi-good';
    if (v <= 100)  return 'aqi-moderate';
    if (v <= 150)  return 'aqi-sensitive';
    if (v <= 200)  return 'aqi-unhealthy';
    if (v <= 300)  return 'aqi-very';
    return 'aqi-hazardous';
  }
  function aqiLabel(v) {
    if (v === null) return 'No Data';
    if (v <= 50)   return 'Good';
    if (v <= 100)  return 'Moderate';
    if (v <= 150)  return 'Sensitive Groups';
    if (v <= 200)  return 'Unhealthy';
    if (v <= 300)  return 'Very Unhealthy';
    return 'Hazardous';
  }
  function aqiBarPct(v) {
    if (!v) return 0;
    return Math.min(100, Math.round((v / 300) * 100));
  }

  function buildAQICard(city, aqi, dominant) {
    var cls = aqiClass(aqi);
    var lbl = aqiLabel(aqi);
    var pct = aqiBarPct(aqi);
    var aqiStr = aqi !== null ? aqi : '—';
    var pollutant = dominant ? '<div style="font-family:var(--mono);font-size:0.6rem;color:rgba(255,255,255,0.3);margin-top:6px;">' + dominant.toUpperCase() + '</div>' : '';
    return '<div class="aqi-card ' + cls + '">' +
      '<div class="aqi-city">' + city.name + '</div>' +
      '<div class="aqi-value">' + aqiStr + '</div>' +
      '<span class="aqi-status">' + lbl + '</span>' +
      pollutant +
      '<div class="aqi-bar"><div class="aqi-bar-fill" style="width:' + pct + '%"></div></div>' +
      '</div>';
  }

  function fetchAQI() {
    var grid = document.getElementById('aqiGrid');
    var html = '';
    var fetched = 0;
    var results = {};

    cities.forEach(function(city) {
      var url = 'https://api.waqi.info/feed/' + city.slug + '/?token=' + AQI_TOKEN;
      fetch(url)
        .then(function(r){ return r.json(); })
        .then(function(data) {
          fetched++;
          var aqi = null, dominant = null;
          if (data && data.status === 'ok' && data.data && typeof data.data.aqi === 'number') {
            aqi = data.data.aqi;
            dominant = data.data.dominentpol || null;
          }
          results[city.id] = { city: city, aqi: aqi, dominant: dominant };

          // Update strip / ticker
          if (city.stripId) {
            var stripEl = document.getElementById(city.stripId);
            if (stripEl) {
              stripEl.textContent = aqi !== null ? aqi : '—';
              stripEl.classList.remove('loading');
              if (aqi > 150) stripEl.classList.add('neg');
              else if (aqi > 100) { stripEl.style.color = '#fb923c'; }
              else if (aqi <= 50) stripEl.classList.add('pos');
            }
          }
          if (city.tickId) {
            var tickEl = document.getElementById(city.tickId);
            if (tickEl) tickEl.textContent = aqi !== null ? aqi + ' AQI' : '—';
          }

          // Rebuild grid when all fetched
          if (fetched === cities.length) {
            var gridHtml = '';
            cities.forEach(function(c) {
              var r = results[c.id] || { aqi: null, dominant: null };
              gridHtml += buildAQICard(c, r.aqi, r.dominant);
            });
            grid.innerHTML = gridHtml;
            setText('data-timestamp', 'Updated ' + nowStr());
          }
        })
        .catch(function() {
          fetched++;
          results[city.id] = { city: city, aqi: null, dominant: null };
          if (fetched === cities.length) {
            var gridHtml = '';
            cities.forEach(function(c) {
              var r = results[c.id] || { aqi: null, dominant: null };
              gridHtml += buildAQICard(c, r.aqi, r.dominant);
            });
            grid.innerHTML = gridHtml;
          }
        });
    });
  }

  /* ══════════════════════════════════════
     3. WORLD NEWS via RSS2JSON
     Sources: BBC World + Reuters
  ══════════════════════════════════════ */
  function timeAgo(dateStr) {
    var then = new Date(dateStr);
    var now  = new Date();
    var diff = Math.floor((now - then) / 60000); // minutes
    if (diff < 1)  return 'Just now';
    if (diff < 60) return diff + 'm ago';
    var h = Math.floor(diff / 60);
    if (h < 24) return h + 'h ago';
    return Math.floor(h / 24) + 'd ago';
  }

  function stripHtml(html) {
    var tmp = document.createElement('div');
    tmp.innerHTML = html;
    return (tmp.textContent || tmp.innerText || '').substring(0, 160).trim();
  }

  function fetchNews() {
    var rssUrl = encodeURIComponent('https://feeds.bbci.co.uk/news/world/rss.xml');
    var apiUrl = 'https://api.rss2json.com/v1/api.json?rss_url=' + rssUrl + '&count=10';

    fetch(apiUrl)
      .then(function(r){ return r.json(); })
      .then(function(data) {
        if (!data.items || !data.items.length) throw new Error('No items');
        var items = data.items.slice(0, 10);
        buildNewsGrid(items);
        var upd = document.getElementById('news-updated');
        if (upd) upd.textContent = 'BBC World · ' + nowStr();
      })
      .catch(function() {
        // Fallback: Reuters via allorigins
        var reuters = encodeURIComponent('https://feeds.reuters.com/reuters/worldNews');
        fetch('https://api.rss2json.com/v1/api.json?rss_url=' + reuters + '&count=10')
          .then(function(r){ return r.json(); })
          .then(function(data) {
            if (!data.items || !data.items.length) throw new Error('No items');
            buildNewsGrid(data.items.slice(0, 10));
            var upd = document.getElementById('news-updated');
            if (upd) upd.textContent = 'Reuters · ' + nowStr();
          })
          .catch(function(){
            var grid = document.getElementById('newsGrid');
            if (grid) grid.innerHTML = '<div class="news-loading" style="color:var(--text-4);">News feed temporarily unavailable. <a href="https://www.bbc.com/news/world" target="_blank" rel="noopener">Visit BBC World →</a></div>';
          });
      });
  }

  function buildNewsGrid(items) {
    var grid   = document.getElementById('newsGrid');
    var strip  = document.getElementById('newsStrip');
    if (!grid) return;

    var top = items.slice(0, 3);
    var rest = items.slice(3, 8);

    var gridHtml = top.map(function(item, i) {
      var excerpt = stripHtml(item.description || '');
      var cls = i === 0 ? 'news-card primary' : 'news-card';
      return '<div class="' + cls + '">' +
        '<div class="nc-source">World News</div>' +
        '<div class="nc-headline"><a href="' + item.link + '" target="_blank" rel="noopener noreferrer">' + item.title + '</a></div>' +
        (i === 0 && excerpt ? '<div class="nc-excerpt">' + excerpt + '…</div>' : '') +
        '<div class="nc-meta">' + timeAgo(item.pubDate) + '</div>' +
        '</div>';
    }).join('');
    grid.innerHTML = gridHtml;

    if (rest.length && strip) {
      strip.style.display = 'flex';
      strip.innerHTML = rest.map(function(item, i) {
        return '<div class="news-strip-item">' +
          '<span class="nsi-num">0' + (i+4) + '</span>' +
          '<span class="nsi-title"><a href="' + item.link + '" target="_blank" rel="noopener noreferrer">' + item.title + '</a></span>' +
          '</div>';
      }).join('');
    }
  }

  /* ══════════════════════════════════════
     INIT
  ══════════════════════════════════════ */
  document.addEventListener('DOMContentLoaded', function() {
    fetchCurrencies();
    fetchAQI();
    fetchNews();

    // Auto-refresh currencies every 5 minutes
    setInterval(fetchCurrencies, 5 * 60 * 1000);
    // Refresh news every 10 minutes
    setInterval(fetchNews, 10 * 60 * 1000);
    // Refresh AQI every 15 minutes
    setInterval(fetchAQI, 15 * 60 * 1000);
  });

})();
</script>

</body>
</html>
